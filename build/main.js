/*! Open-Logger 2015-02-10 */
var requirejs=require("requirejs");requirejs.config({baseUrl:"script",nodeRequire:require}),requirejs(["fs","iconv-lite","lazy","file","config","LogEntity","moment","normalFilter"],function(a,b,c,d,e,f,g,h){function i(){var a=e.styles,b=0;a.forEach(function(a){$("#styleSelect").append('<option value="'+b+'">'+a.name+"</option>"),b++}),z=a[0],A=a[0],$("#styleSelect").on("change",function(){A=z,z=a[$("#styleSelect").val()],p(z)})}function j(a,b,c){a.submenu.append(new B.MenuItem({label:b,click:c}))}function k(a){a.submenu.append(new B.MenuItem({type:"separator"}))}function l(a){$("#"+a).click()}function m(){var a=new B.Menu({type:"menubar"});a.append(new B.MenuItem({label:"File",submenu:new B.Menu})),j(a.items[0],"Import",function(){l("import")}),j(a.items[0],"Export",function(){l("export")}),k(a.items[0]),j(a.items[0],"Exit",function(){B.Window.get().close()}),B.Window.get().menu=a,$("#import").on("change",function(){var a=$(this).val();a&&y(a,e.previewSize,function(b,c){n(),o(a,r(1,c.split("\n"))),p(z),q(A,z)})}),$("#export").on("change",function(){var a=$(this).val();if(a){var b=$("#filterLogs").text(),c=b.split("\n"),e=[];c.forEach(function(a){e.push(a.slice(a.indexOf("|")+2))}),d.save(a,e.join("\n"),z.encoding)}})}function n(){$("#type").empty(),$("#previewLogs").scrollTop(0),$("#previewLogs").text(""),$("#filterLogs").scrollTop(0),$("#filterLogs").text(""),$("#status").text(""),$("#resultCount").text(""),$("#logCount").text(""),$("#lineCount").text("")}function o(a,b){B.Window.get().title=a,$("#previewLogs").text(b.join("\n")),$(".logDiv").show()}function p(a){$(".dynamic").remove();var b=a.filters;b.forEach(function(b){"time"===b.type?($("#filterControl").append('<span class="dynamic">'+b.name+' : </span><input id="startTime" class="dynamic"></input><span class="dynamic"> - </span><input id="endTime" class="dynamic"></input>'),$("#startTime").datetimepicker({dateFormat:a.dateFormat,timeFormat:a.timeFormat}),$("#endTime").datetimepicker({dateFormat:a.dateFormat,timeFormat:a.timeFormat})):("normal"===b.type||"message"===b.type)&&$("#filterControl").append('<span class="dynamic">'+b.name+' : </span><input id="'+b.id+'" class="'+b.type+' dynamic" type="text"></input>')})}function q(a,b){a.filters.forEach(function(a){delete f.prototype[a.id]}),b.filters.forEach(function(a){f.prototype[a.id]=""})}function r(a,b){var c=a,d=[],e=5;a.toString().length>5&&(e=a.toString().length);var f=new Array(e).join(" ");return b.forEach(function(a){d.push((f+c).slice(-e)+" | "+a.replace(/\t/g,"    ")),c++}),d}function s(){return new RegExp(z.starter)}function t(){var a=[];return z.filters.forEach(function(b){a.push(b.regex)}),new RegExp(a.join(z.separator))}function u(){var d;$("#endFilter").on("click",function(){console.log("end click"),void 0!==d&&(d.listeners("pipe"),d=void 0,console.log("issue pipe"))}),$("#startFilter").on("click",function(){$("#filterLogs").text(""),$("#status").text("processing"),$("#resultCount").text(""),$("#logCount").text(""),$("#lineCount").text("");var g,i=B.Window.get().title,j=[],k=[],l=1,m=0,n=s(),o=t(),p=0,q=function(a,b){var c=[];z.filters.forEach(function(b){"time"===b.type?a=w(a):("normal"===b.type||"message"===b.type)&&(a=h.doFilter($,a,b.id))}),a.forEach(function(a){c.push(a.originLog)}),$("#filterLogs").append(c.join("\n")),p+=c.length,$("#resultCount").text(p),b===!0&&$("#status").text("finished")};d=new c(a.createReadStream(i).pipe(b.decodeStream(z.encoding))).lines.map(String).forEach(function(a){var b=a.match(n);if(b){if(g){var c=r(l,j);l+=j.length,$("#lineCount").text(l),g.originLog=c.join("\n"),k.push(g),j.length=0}g=new f,j.push(a),m++,$("#logCount").text(m),m%e.blockSize===0&&(q(k,!1),k.length=0,$("#logCount").text(m));var d=a.match(o),h=1;z.filters.forEach(function(a){var b="";b="time"===a.type?d[h].substring(0,d[h].length+z.adjustSize-1):d[h],g[a.id]=b,h++})}else{if(void 0===g)return l++,void $("#lineCount").text(l);var i=z.filters[z.filters.length-1];g[i]=g[i]+a,j.push(a)}}).on("pipe",function(){var a=r(l,j);l+=j.length,g&&(g.originLog=a.join("\n"),k.push(g)),q(k,!0)})})}function v(a){return a.dateFormat+" "+a.timeFormat+a.lastFormat}function w(a){var b,c,d=$("#startTime").val(),e=$("#endTime").val(),f=0,h=a.length,i=v(z);d&&(b=g(d,i).format("x"),f=x(a,b)),e&&(c=g(e,i).format("x"),h=x(a,c));var j=a.slice(f,h);return j}function x(a,b){for(var c,d,e=0,f=a.length-1,g=v(z);f>=e;)if(c=(e+f)/2|0,d=a[c].getFormatTime(g),b>d)e=c+1;else{if(!(d>b))return c;f=c-1}return c}function y(c,d,e){var f=a.createReadStream(c,{flags:"r",fd:null,mode:438,bufferSize:65536}),g="";f.on("data",function(a){var c=b.decode(a,z.encoding);g+=c;var h=g.split("\n");h.length>=d&&(f.destroy(),e(null,g))}),f.on("error",function(){e("Error",null)}),f.on("end",function(){e(null,g)})}var z,A,B=require("nw.gui");$(function(){m(),i(),u()})});