/*! Open-Logger 2014-12-14 */
var requirejs=require("requirejs");requirejs.config({baseUrl:"script",nodeRequire:require}),requirejs(["node-syntaxhighlighter","file","config","LogEntity","moment","normalFilter"],function(a,b,c,d,e,f){function g(a,b,c){a.submenu.append(new r.MenuItem({label:b,click:c}))}function h(a){a.submenu.append(new r.MenuItem({type:"separator"}))}function i(a){$("#"+a).click()}function j(){var a=new r.Menu({type:"menubar"});a.append(new r.MenuItem({label:"File",submenu:new r.Menu})),g(a.items[0],"Import",function(){i("import")}),g(a.items[0],"Export",function(){}),h(a.items[0]),g(a.items[0],"Exit",function(){r.Window.get().close()}),r.Window.get().menu=a}function k(){var c=0;$("#import").on("change",function(){r.Window.get().title=$(this).val(),b.open($(this).val(),function(b,d){c=0,s=d.split("\n"),m(s);var e=l(s,c,1e3);if(e){a.sh.defaults["auto-links"]=!1,$("#previewContent").html(a.highlight(e.contents,a.getLanguage("plain"))),c=e.endCursor,$("#filePath").val(b),$(".logDiv").show(700);var f=function(){$("#previewContent div").first().on("scroll",function(){if($("#previewContent div").first().scrollTop()+$("#previewContent div").first().height()>$("#previewContent div table").height()-100){var b=$("#previewContent div").first().scrollTop(),d=l(s,c,1e3);d&&($("#previewContent").html(a.highlight(d.contents,a.getLanguage("plain"))),$("#previewContent div").first().scrollTop(b),c=d.endCursor,f())}})};f()}})})}function l(a,b,c){var d=b+c;return d>=a.length&&(d=a.length-1),d===b?void 0:{endCursor:d,contents:a.slice(0,d).join("\n")}}function m(a){var b,c=new RegExp(/^\[([^\[\]]*)\]/),e=new RegExp(/\[([^\[\]]*)\]\s*(\S*)\s*(\S*)\s*(\S*)\s*(.*)/);a.forEach(function(a,f){var g=a.match(c);if(g){b&&t.push(b),b=new d;var h=a.match(e);b.update(f,h[1],h[2],h[3],h[4],h[5])}else{if(void 0===b)return;b.appendMessage(a)}})}function n(){$("#startTime").datetimepicker({dateFormat:c.dateFormat,timeFormat:c.timeFormat}),$("#endTime").datetimepicker({dateFormat:c.dateFormat,timeFormat:c.timeFormat}),$("#startFilter").on("click",function(){var b=[];b=o(t),u.forEach(function(){b=f.doFilter(b,filterTarger)}),$("#message").val()&&(b=q(b));var c=[];b.forEach(function(a){c.push(s[a.lineNumber])}),$("#filterContent").html(a.highlight(resultLines.join("\n"),a.getLanguage("plain")))})}function o(a){var b,d,f=$("#startTime").val(),g=$("#endTime").val();f&&(b=e(f,c.fullFormat)),g&&(d=e(g,c.fullFormat));var h=[];return a.forEach(function(a){var f=e(a.time.substring(0,a.time.length+c.adjustSize-1),c.fullFormat);p(f,b,d)&&h.push(a)}),h}function p(a,b,c){return b&&c?(a.isAfter(b)||a.isSame(b))&&(a.isBefore(c)||a.isSame(c)):b?a.isAfter(b)||a.isSame(b):c?a.isBefore(c)||a.isSame(c):!0}function q(a){var b=[],c=$("#message").val();return a.forEach(function(a){a.message.toLowerCase().indexof(c.toLowerCase())>-1&&b.push(a)}),b}var r=require("nw.gui"),s=[],t=[],u=["threadId","producer","type"];$(function(){k(),j(),n()})});